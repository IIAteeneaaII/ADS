<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title><%= habit ? habit.name : 'Hábito personalizado' %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <%- include('partials/allStyles') %>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pikaday/plugins/pikaday.es.js"></script>
</head>

<body class="form_habitos">
  <div class="container py-4">
    <div class="top-bar">
      <a href="/gestionarHabitos" class="back-arrow"><i class="fas fa-chevron-left"></i></a>
      <h1 class="mx-auto">Hábito personalizado</h1>
    </div>

    <div class="tab-content mt-4 texto-alternativo">
      <form id="form-habito">
        <input type="hidden" id="habitId" value="<%= habit ? habit.id : '' %>">

        <div class="mb-3">
          <label for="name" class="form-label">Nombre del hábito*</label>
          <input type="text" class="form-control" id="name" name="name" placeholder="Ej. Leer antes de dormir" value="<%= habit ? habit.name : '' %>">
        </div>

        <div class="mb-3">
          <label for="description" class="form-label">Descripción*</label>
          <textarea class="form-control" id="description" name="description" rows="3"><%= habit ? habit.description : '' %></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Tiempo a realizar al día (en minutos)*</label>
          <div class="d-flex align-items-center">
            <input type="number" class="form-control me-2" name="fieldValues[value]" value="<%= habit ? habit.fieldValues?.value : 1 %>" min="1">
            <span>min</span>
            <input type="hidden" name="fieldValues[unit]" value="min">
          </div>
        </div>

        <div class="mb-3">
          <label for="startDate" class="form-label">Fecha de inicio*</label>
          <input type="text" class="form-control calendario" id="startDate" name="startDate" value="<%= habit ? habit.startDate.toISOString().split('T')[0] : '' %>">
        </div>

        <div class="mb-3">
          <input type="hidden" name="frequency[type]" value="weekly">
          <label class="form-label">Días de la semana*</label>
          <div class="d-flex flex-wrap gap-2">
            <% const days = habit?.frequency?.days || []; %>
            <% const allDays = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday']; %>
            <% allDays.forEach(day => { %>
              <input type="checkbox" class="btn-check" name="frequency[days][]" value="<%= day %>" id="<%= day %>" <%= days.includes(day) ? 'checked' : '' %>>
              <label class="btn btn-outline-secondary rounded-pill <%= days.includes(day) ? 'dia_selected' : '' %>" for="<%= day %>">
                <%= day.charAt(0).toUpperCase() + day.slice(1,3) %>
              </label>
            <% }); %>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label" for="reminder">¿Deseas recibir notificaciones?</label>
          <select class="form-control" name="reminder" id="reminder">
            <option value="">Selecciona una opción</option>
            <option value="yes" <%= habit && habit.reminder ? 'selected' : '' %>>Sí</option>
            <option value="no" <%= habit && habit.reminder === false ? 'selected' : '' %>>No</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary">Guardar hábito</button>
      </form>
    </div>
  </div>

  <script>
    new Pikaday({
      field: document.getElementById('startDate'),
      format: 'YYYY-MM-DD',
      i18n: {
        previousMonth: 'Mes anterior',
        nextMonth: 'Mes siguiente',
        months: ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'],
        weekdays: ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'],
        weekdaysShort: ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb']
      },
      toString(date) {
        return date.toISOString().split('T')[0];
      },
      minDate: new Date()
    });

    document.getElementById('form-habito').addEventListener('submit', async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const id = document.getElementById('habitId').value;

      const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        frequency: {
          type: formData.get('frequency[type]'),
          days: formData.getAll('frequency[days][]')
        },
        icon: "../img/gestorhabitos/personalizado.png",
        startDate: new Date(formData.get('startDate')).toISOString(),
        fieldValues: {
          unit: formData.get('fieldValues[unit]'),
          value: formData.get('fieldValues[value]')
        },
        reminder: formData.get('reminder') === 'yes'
      };

      const url = id ? `/api/habit/${id}` : '/api/habit/personalizado';
      const method = id ? 'PUT' : 'POST';

      try {
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error('Error al guardar el hábito');

        const result = await response.json();
        const redirectId = id || result.habit.id;
        window.location.href = `/perso/${redirectId}`;
      } catch (error) {
        console.error('Error al enviar el hábito:', error);
        alert('Ocurrió un error al guardar el hábito.');
      }
    });

    document.querySelectorAll('.btn-outline-secondary').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.classList.toggle('dia_selected');
      });
    });
  </script>
</body>
</html>
